<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ã‚«ãƒ¡ãƒ©è¨ºæ–­ãƒ†ã‚¹ãƒˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f0f0f0;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    
    .success { background: #d4edda; color: #155724; }
    .warning { background: #fff3cd; color: #856404; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      font-size: 16px;
    }
    
    button:hover {
      background: #0056b3;
    }
    
    video {
      width: 100%;
      max-width: 640px;
      height: auto;
      border: 2px solid #007bff;
      border-radius: 5px;
      margin: 10px 0;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ“± ã‚«ãƒ¡ãƒ©è¨ºæ–­ãƒ†ã‚¹ãƒˆ</h1>
    
    <div id="protocol-check" class="status info">
      <span id="protocol-status">ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒã‚§ãƒƒã‚¯ä¸­...</span>
    </div>
    
    <div id="camera-support" class="status info">
      <span id="support-status">ã‚«ãƒ¡ãƒ©ã‚µãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ä¸­...</span>
    </div>
    
    <div id="camera-status" class="status info">
      <span id="status-text">æº–å‚™ä¸­...</span>
    </div>
    
    <button id="start-camera" onclick="startCamera()">ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹</button>
    <button id="switch-camera" onclick="switchCamera()" class="hidden">ğŸ”„ ã‚«ãƒ¡ãƒ©åˆ‡ã‚Šæ›¿ãˆ</button>
    
    <video id="camera-video" autoplay playsinline class="hidden"></video>
    
    <div id="camera-info" class="hidden">
      <h3>ğŸ“‹ ã‚«ãƒ¡ãƒ©æƒ…å ±</h3>
      <div id="camera-details"></div>
    </div>
    
    <div id="error-details" class="hidden">
      <h3>âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°</h3>
      <div id="error-info"></div>
    </div>
    
    <div id="ar-test" class="hidden">
      <h3>ğŸ¯ AR.jsãƒ†ã‚¹ãƒˆ</h3>
      <button onclick="startARTest()">AR.jsãƒ†ã‚¹ãƒˆã‚’é–‹å§‹</button>
      <div id="ar-container"></div>
    </div>
  </div>

  <script>
    let currentStream = null;
    let facingMode = 'environment'; // ãƒãƒƒã‚¯ã‚«ãƒ¡ãƒ©ã‹ã‚‰é–‹å§‹
    
    // ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒã‚§ãƒƒã‚¯
    function checkProtocol() {
      const protocolStatus = document.getElementById('protocol-status');
      const protocolCheck = document.getElementById('protocol-check');
      
      if (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
        protocolStatus.textContent = 'âœ… HTTPSç’°å¢ƒã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã™';
        protocolCheck.className = 'status success';
      } else {
        protocolStatus.textContent = 'âŒ HTTPSç’°å¢ƒãŒå¿…è¦ã§ã™ã€‚https://ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„';
        protocolCheck.className = 'status error';
      }
    }
    
    // ã‚«ãƒ¡ãƒ©ã‚µãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
    function checkCameraSupport() {
      const supportStatus = document.getElementById('support-status');
      const cameraSupport = document.getElementById('camera-support');
      
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        supportStatus.textContent = 'âœ… ã‚«ãƒ¡ãƒ©APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™';
        cameraSupport.className = 'status success';
      } else {
        supportStatus.textContent = 'âŒ ã‚«ãƒ¡ãƒ©APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“';
        cameraSupport.className = 'status error';
      }
    }
    
    // ã‚«ãƒ¡ãƒ©é–‹å§‹
    async function startCamera() {
      const video = document.getElementById('camera-video');
      const statusText = document.getElementById('status-text');
      const cameraStatus = document.getElementById('camera-status');
      const errorDetails = document.getElementById('error-details');
      const errorInfo = document.getElementById('error-info');
      
      try {
        statusText.textContent = 'ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ä¸­...';
        cameraStatus.className = 'status info';
        
        // æ—¢å­˜ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
        }
        
        // ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹
        const constraints = {
          video: {
            facingMode: facingMode,
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        };
        
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = currentStream;
        
        statusText.textContent = 'âœ… ã‚«ãƒ¡ãƒ©ãŒæ­£å¸¸ã«é–‹å§‹ã•ã‚Œã¾ã—ãŸ';
        cameraStatus.className = 'status success';
        
        video.classList.remove('hidden');
        document.getElementById('switch-camera').classList.remove('hidden');
        document.getElementById('camera-info').classList.remove('hidden');
        document.getElementById('ar-test').classList.remove('hidden');
        
        // ã‚«ãƒ¡ãƒ©æƒ…å ±ã‚’è¡¨ç¤º
        showCameraInfo();
        
      } catch (error) {
        console.error('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:', error);
        statusText.textContent = 'âŒ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ';
        cameraStatus.className = 'status error';
        
        errorDetails.classList.remove('hidden');
        errorInfo.innerHTML = `
          <strong>ã‚¨ãƒ©ãƒ¼å:</strong> ${error.name}<br>
          <strong>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong> ${error.message}<br>
          <strong>å¯¾å‡¦æ³•:</strong> ${getErrorSolution(error.name)}
        `;
      }
    }
    
    // ã‚«ãƒ¡ãƒ©åˆ‡ã‚Šæ›¿ãˆ
    async function switchCamera() {
      facingMode = facingMode === 'environment' ? 'user' : 'environment';
      const statusText = document.getElementById('status-text');
      statusText.textContent = `${facingMode === 'environment' ? 'ãƒãƒƒã‚¯' : 'ãƒ•ãƒ­ãƒ³ãƒˆ'}ã‚«ãƒ¡ãƒ©ã«åˆ‡ã‚Šæ›¿ãˆä¸­...`;
      await startCamera();
    }
    
    // ã‚«ãƒ¡ãƒ©æƒ…å ±è¡¨ç¤º
    function showCameraInfo() {
      const cameraDetails = document.getElementById('camera-details');
      const video = document.getElementById('camera-video');
      
      video.addEventListener('loadedmetadata', () => {
        cameraDetails.innerHTML = `
          <strong>è§£åƒåº¦:</strong> ${video.videoWidth} x ${video.videoHeight}<br>
          <strong>ã‚«ãƒ¡ãƒ©:</strong> ${facingMode === 'environment' ? 'ãƒãƒƒã‚¯ã‚«ãƒ¡ãƒ©' : 'ãƒ•ãƒ­ãƒ³ãƒˆã‚«ãƒ¡ãƒ©'}<br>
          <strong>ã‚¹ãƒˆãƒªãƒ¼ãƒ çŠ¶æ…‹:</strong> ${currentStream ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}
        `;
      });
    }
    
    // ã‚¨ãƒ©ãƒ¼å¯¾å‡¦æ³•
    function getErrorSolution(errorName) {
      switch (errorName) {
        case 'NotAllowedError':
          return 'ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚';
        case 'NotFoundError':
          return 'ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚«ãƒ¡ãƒ©ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        case 'NotReadableError':
          return 'ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ä¸­ã§ã™ã€‚ä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        case 'OverconstrainedError':
          return 'ã‚«ãƒ¡ãƒ©ã®è¨­å®šãŒå¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚åˆ¥ã®ã‚«ãƒ¡ãƒ©ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚';
        case 'SecurityError':
          return 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚HTTPSç’°å¢ƒã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚';
        default:
          return 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å†èµ·å‹•ã—ã¦ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚';
      }
    }
    
    // AR.jsãƒ†ã‚¹ãƒˆ
    function startARTest() {
      const arContainer = document.getElementById('ar-container');
      arContainer.innerHTML = `
        <p>ã‚«ãƒ¡ãƒ©ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹å ´åˆã€AR.jsãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã§ãã¾ã™ã€‚</p>
        <button onclick="loadARScene()">AR.jsã‚·ãƒ¼ãƒ³ã‚’èª­ã¿è¾¼ã‚€</button>
      `;
    }
    
    // AR.jsã‚·ãƒ¼ãƒ³èª­ã¿è¾¼ã¿
    function loadARScene() {
      const arContainer = document.getElementById('ar-container');
      arContainer.innerHTML = `
        <div style="margin: 20px 0;">
          <p>AR.jsã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
          <div id="ar-scene-container"></div>
        </div>
      `;
      
      // AR.jsã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿
      const aframeScript = document.createElement('script');
      aframeScript.src = 'https://aframe.io/releases/1.4.0/aframe.min.js';
      aframeScript.onload = () => {
        const arScript = document.createElement('script');
        arScript.src = 'https://cdn.jsdelivr.net/npm/ar.js@3.4.5/aframe/build/aframe-ar.js';
        arScript.onload = () => {
          createARScene();
        };
        document.head.appendChild(arScript);
      };
      document.head.appendChild(aframeScript);
    }
    
    // ARã‚·ãƒ¼ãƒ³ä½œæˆ
    function createARScene() {
      const arSceneContainer = document.getElementById('ar-scene-container');
      arSceneContainer.innerHTML = `
        <a-scene
          embedded
          arjs="sourceType: webcam; debugUIEnabled: false;"
          style="width: 100%; height: 400px;"
        >
          <a-marker preset="hiro">
            <a-box position="0 0.5 0" color="red" animation="property: rotation; to: 0 360 0; loop: true; dur: 2000"></a-box>
          </a-marker>
          <a-entity camera></a-entity>
        </a-scene>
      `;
    }
    
    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
      checkProtocol();
      checkCameraSupport();
    });
  </script>
</body>
</html>