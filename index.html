<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>カメラ診断テスト</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f0f0f0;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    
    .success { background: #d4edda; color: #155724; }
    .warning { background: #fff3cd; color: #856404; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      font-size: 16px;
    }
    
    button:hover {
      background: #0056b3;
    }
    
    video {
      width: 100%;
      max-width: 640px;
      height: auto;
      border: 2px solid #007bff;
      border-radius: 5px;
      margin: 10px 0;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>📱 カメラ診断テスト</h1>
    
    <div id="protocol-check" class="status info">
      <span id="protocol-status">プロトコルチェック中...</span>
    </div>
    
    <div id="camera-support" class="status info">
      <span id="support-status">カメラサポートチェック中...</span>
    </div>
    
    <div id="camera-status" class="status info">
      <span id="status-text">準備中...</span>
    </div>
    
    <button id="start-camera" onclick="startCamera()">📷 カメラを開始</button>
    <button id="switch-camera" onclick="switchCamera()" class="hidden">🔄 カメラ切り替え</button>
    
    <video id="camera-video" autoplay playsinline class="hidden"></video>
    
    <div id="camera-info" class="hidden">
      <h3>📋 カメラ情報</h3>
      <div id="camera-details"></div>
    </div>
    
    <div id="error-details" class="hidden">
      <h3>❌ エラー詳細</h3>
      <div id="error-info"></div>
    </div>
    
    <div id="ar-test" class="hidden">
      <h3>🎯 AR.jsテスト</h3>
      <button onclick="startARTest()">AR.jsテストを開始</button>
      <div id="ar-container"></div>
    </div>
  </div>

  <script>
    let currentStream = null;
    let facingMode = 'environment'; // バックカメラから開始
    
    // プロトコルチェック
    function checkProtocol() {
      const protocolStatus = document.getElementById('protocol-status');
      const protocolCheck = document.getElementById('protocol-check');
      
      if (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
        protocolStatus.textContent = '✅ HTTPS環境またはローカル環境です';
        protocolCheck.className = 'status success';
      } else {
        protocolStatus.textContent = '❌ HTTPS環境が必要です。https://でアクセスしてください';
        protocolCheck.className = 'status error';
      }
    }
    
    // カメラサポートチェック
    function checkCameraSupport() {
      const supportStatus = document.getElementById('support-status');
      const cameraSupport = document.getElementById('camera-support');
      
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        supportStatus.textContent = '✅ カメラAPIがサポートされています';
        cameraSupport.className = 'status success';
      } else {
        supportStatus.textContent = '❌ カメラAPIがサポートされていません';
        cameraSupport.className = 'status error';
      }
    }
    
    // カメラ開始
    async function startCamera() {
      const video = document.getElementById('camera-video');
      const statusText = document.getElementById('status-text');
      const cameraStatus = document.getElementById('camera-status');
      const errorDetails = document.getElementById('error-details');
      const errorInfo = document.getElementById('error-info');
      
      try {
        statusText.textContent = 'カメラアクセス中...';
        cameraStatus.className = 'status info';
        
        // 既存のストリームを停止
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
        }
        
        // カメラアクセス
        const constraints = {
          video: {
            facingMode: facingMode,
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        };
        
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = currentStream;
        
        statusText.textContent = '✅ カメラが正常に開始されました';
        cameraStatus.className = 'status success';
        
        video.classList.remove('hidden');
        document.getElementById('switch-camera').classList.remove('hidden');
        document.getElementById('camera-info').classList.remove('hidden');
        document.getElementById('ar-test').classList.remove('hidden');
        
        // カメラ情報を表示
        showCameraInfo();
        
      } catch (error) {
        console.error('カメラエラー:', error);
        statusText.textContent = '❌ カメラアクセスに失敗しました';
        cameraStatus.className = 'status error';
        
        errorDetails.classList.remove('hidden');
        errorInfo.innerHTML = `
          <strong>エラー名:</strong> ${error.name}<br>
          <strong>エラーメッセージ:</strong> ${error.message}<br>
          <strong>対処法:</strong> ${getErrorSolution(error.name)}
        `;
      }
    }
    
    // カメラ切り替え
    async function switchCamera() {
      facingMode = facingMode === 'environment' ? 'user' : 'environment';
      const statusText = document.getElementById('status-text');
      statusText.textContent = `${facingMode === 'environment' ? 'バック' : 'フロント'}カメラに切り替え中...`;
      await startCamera();
    }
    
    // カメラ情報表示
    function showCameraInfo() {
      const cameraDetails = document.getElementById('camera-details');
      const video = document.getElementById('camera-video');
      
      video.addEventListener('loadedmetadata', () => {
        cameraDetails.innerHTML = `
          <strong>解像度:</strong> ${video.videoWidth} x ${video.videoHeight}<br>
          <strong>カメラ:</strong> ${facingMode === 'environment' ? 'バックカメラ' : 'フロントカメラ'}<br>
          <strong>ストリーム状態:</strong> ${currentStream ? '有効' : '無効'}
        `;
      });
    }
    
    // エラー対処法
    function getErrorSolution(errorName) {
      switch (errorName) {
        case 'NotAllowedError':
          return 'カメラアクセスが拒否されました。ブラウザの設定でカメラアクセスを許可してください。';
        case 'NotFoundError':
          return 'カメラが見つかりません。カメラが接続されているか確認してください。';
        case 'NotReadableError':
          return 'カメラが使用中です。他のアプリケーションでカメラを使用していないか確認してください。';
        case 'OverconstrainedError':
          return 'カメラの設定が対応していません。別のカメラを試してください。';
        case 'SecurityError':
          return 'セキュリティエラーです。HTTPS環境でアクセスしてください。';
        default:
          return '不明なエラーです。ブラウザを再起動してもう一度試してください。';
      }
    }
    
    // AR.jsテスト
    function startARTest() {
      const arContainer = document.getElementById('ar-container');
      arContainer.innerHTML = `
        <p>カメラが正常に動作している場合、AR.jsテストを開始できます。</p>
        <button onclick="loadARScene()">AR.jsシーンを読み込む</button>
      `;
    }
    
    // AR.jsシーン読み込み
    function loadARScene() {
      const arContainer = document.getElementById('ar-container');
      arContainer.innerHTML = `
        <div style="margin: 20px 0;">
          <p>AR.jsを読み込んでいます...</p>
          <div id="ar-scene-container"></div>
        </div>
      `;
      
      // AR.jsスクリプトを動的に読み込み
      const aframeScript = document.createElement('script');
      aframeScript.src = 'https://aframe.io/releases/1.4.0/aframe.min.js';
      aframeScript.onload = () => {
        const arScript = document.createElement('script');
        arScript.src = 'https://cdn.jsdelivr.net/npm/ar.js@3.4.5/aframe/build/aframe-ar.js';
        arScript.onload = () => {
          createARScene();
        };
        document.head.appendChild(arScript);
      };
      document.head.appendChild(aframeScript);
    }
    
    // ARシーン作成
    function createARScene() {
      const arSceneContainer = document.getElementById('ar-scene-container');
      arSceneContainer.innerHTML = `
        <a-scene
          embedded
          arjs="sourceType: webcam; debugUIEnabled: false;"
          style="width: 100%; height: 400px;"
        >
          <a-marker preset="hiro">
            <a-box position="0 0.5 0" color="red" animation="property: rotation; to: 0 360 0; loop: true; dur: 2000"></a-box>
          </a-marker>
          <a-entity camera></a-entity>
        </a-scene>
      `;
    }
    
    // 初期化
    document.addEventListener('DOMContentLoaded', () => {
      checkProtocol();
      checkCameraSupport();
    });
  </script>
</body>
</html>