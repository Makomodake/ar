<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>マーカー検出最適化AR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.5/aframe/build/aframe-ar.js"></script>
  
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }
    
    .info-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
      max-width: 300px;
      line-height: 1.4;
    }
    
    .status {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255, 0, 0, 0.8);
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      font-size: 16px;
      font-weight: bold;
    }
    
    .status.detected {
      background: rgba(0, 255, 0, 0.8);
    }
    
    .controls {
      position: absolute;
      top: 10px;
      right: 10px;
      pointer-events: auto;
    }
    
    .control-btn {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      padding: 10px 15px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .control-btn:hover {
      background: rgba(0, 0, 0, 0.9);
    }
    
    .marker-guide {
      position: absolute;
      bottom: 80px;
      left: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
    }
    
    .marker-image {
      width: 100px;
      height: 100px;
      background: white;
      border: 2px solid #333;
      margin: 10px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: black;
    }
    
    .debug-info {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 11px;
      max-width: 200px;
    }
  </style>
</head>

<body>
  <div class="overlay">
    <div class="info-panel">
      <div><strong>📱 ARマーカー検出テスト</strong></div>
      <div>・下のHiroマーカーをカメラに向けてください</div>
      <div>・マーカーから15-30cm離してください</div>
      <div>・明るい場所で使用してください</div>
      <div>・マーカーが平らで歪みがないか確認</div>
      
      <div class="marker-image">
        <div style="text-align: center;">
          <div style="font-weight: bold; margin-bottom: 5px;">HIRO</div>
          <div style="font-size: 8px;">この画像を印刷するか<br>スマホで別画面に表示</div>
        </div>
      </div>
    </div>
    
    <div class="controls">
      <button class="control-btn" onclick="toggleDebug()">🔍 デバッグ表示</button>
      <button class="control-btn" onclick="resetCamera()">🔄 カメラリセット</button>
    </div>
    
    <div class="marker-guide">
      <strong>マーカー検出のコツ:</strong><br>
      ・マーカーを画面中央に配置<br>
      ・ゆっくりと動かす<br>
      ・照明が均等に当たるように
    </div>
    
    <div class="status" id="status">❌ マーカーを探しています...</div>
    
    <div class="debug-info" id="debug-info" style="display: none;">
      <div>フレームレート: <span id="fps">0</span> fps</div>
      <div>解像度: <span id="resolution">-</span></div>
      <div>検出感度: <span id="sensitivity">標準</span></div>
    </div>
  </div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    arjs="
      sourceType: webcam;
      facingMode: environment;
      debugUIEnabled: false;
      detectionMode: mono_and_matrix;
      matrixCodeType: 3x3;
      cameraParametersUrl: https://cdn.jsdelivr.net/npm/ar.js@3.4.5/aframe/examples/marker-training/examples/camera_para.dat;
      maxDetectionRate: 60;
      canvasWidth: 640;
      canvasHeight: 480;
      sourceWidth: 640;
      sourceHeight: 480;
      displayWidth: 640;
      displayHeight: 480;"
  >
    <a-assets timeout="30000">
      <a-mixin id="highlight-animation" 
               animation__scale="property: scale; to: 1.2 1.2 1.2; dir: alternate; dur: 1000; loop: true"
               animation__rotate="property: rotation; to: 0 360 0; dur: 5000; loop: true">
      </a-mixin>
      
      <a-mixin id="bounce-animation"
               animation="property: position; to: 0 2 0; dir: alternate; dur: 2000; loop: true; easing: easeInOutQuad">
      </a-mixin>
    </a-assets>

    <!-- Hiroマーカー：検出感度を最適化 -->
    <a-marker 
      preset="hiro" 
      id="hiro-marker"
      raycaster="objects: .clickable"
      cursor="fuse: false; rayOrigin: mouse;"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5"
    >
      <!-- メインの立方体 -->
      <a-box 
        position="0 0.5 0" 
        color="#ff4444" 
        depth="1" 
        height="1" 
        width="1"
        material="opacity: 0.9; metalness: 0.2; roughness: 0.8"
        shadow="cast: true; receive: true"
        mixin="highlight-animation"
        class="clickable"
        sound="on: click; src: url(data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwgBTiG0fPTgjMGHWq+8+OZREQM...);"
      >
        <a-text 
          value="HIRO!" 
          position="0 1.5 0" 
          align="center" 
          color="white"
          scale="2 2 2"
          material="shader: msdf; font: roboto"
        ></a-text>
      </a-box>
      
      <!-- 回転する球体 -->
      <a-sphere 
        position="2 1 0" 
        radius="0.5" 
        color="#4444ff"
        material="opacity: 0.8; metalness: 0.5; roughness: 0.2"
        mixin="bounce-animation"
        class="clickable"
      ></a-sphere>
      
      <!-- 伸縮する円柱 -->
      <a-cylinder 
        position="-2 0.5 0" 
        radius="0.5" 
        height="1" 
        color="#44ff44"
        material="opacity: 0.8; metalness: 0.3; roughness: 0.4"
        animation="property: scale; to: 1 2 1; dir: alternate; dur: 1500; loop: true"
        class="clickable"
      ></a-cylinder>
      
      <!-- 光る三角錐 -->
      <a-cone 
        position="0 0.5 2" 
        radius-bottom="0.5" 
        height="1" 
        color="#ffff44"
        material="opacity: 0.9; emissive: #444400; metalness: 0.1; roughness: 0.3"
        animation="property: rotation; to: 0 360 0; dur: 3000; loop: true"
        class="clickable"
      ></a-cone>
      
      <!-- 環境光とライト -->
      <a-light type="ambient" color="#404040" intensity="0.5"></a-light>
      <a-light type="point" position="0 2 0" color="#ffffff" intensity="0.8"></a-light>
    </a-marker>

    <!-- カメラ設定 -->
    <a-entity 
      camera 
      look-controls-enabled="false" 
      arjs-look-controls="smoothingFactor: 0.1"
      raycaster="objects: .clickable"
      cursor="fuse: false; rayOrigin: mouse"
    ></a-entity>
  </a-scene>

  <script>
    let debugMode = false;
    let frameCount = 0;
    let lastTime = Date.now();
    
    // DOM要素の取得
    const marker = document.querySelector('#hiro-marker');
    const status = document.querySelector('#status');
    const debugInfo = document.querySelector('#debug-info');
    const fpsElement = document.querySelector('#fps');
    const resolutionElement = document.querySelector('#resolution');
    
    // マーカー検出イベント
    if (marker && status) {
      marker.addEventListener('markerFound', function() {
        console.log('マーカー検出！');
        status.textContent = '✅ マーカー検出中 - オブジェクトが表示されています';
        status.classList.add('detected');
        
        // 検出音を再生（オプション）
        playDetectionSound();
      });
      
      marker.addEventListener('markerLost', function() {
        console.log('マーカー消失');
        status.textContent = '❌ マーカーを探しています...';
        status.classList.remove('detected');
      });
    }
    
    // 検出音を再生
    function playDetectionSound() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.3);
    }
    
    // デバッグ表示の切り替え
    function toggleDebug() {
      debugMode = !debugMode;
      debugInfo.style.display = debugMode ? 'block' : 'none';
      
      // AR.jsのデバッグUIも切り替え
      const scene = document.querySelector('a-scene');
      if (scene) {
        scene.setAttribute('arjs', scene.getAttribute('arjs') + `; debugUIEnabled: ${debugMode}`);
      }
    }
    
    // カメラリセット
    function resetCamera() {
      status.textContent = '🔄 カメラをリセット中...';
      status.classList.remove('detected');
      
      // ページを再読み込み
      setTimeout(() => {
        location.reload();
      }, 1000);
    }
    
    // FPS監視
    function updateFPS() {
      frameCount++;
      const now = Date.now();
      if (now - lastTime >= 1000) {
        const fps = Math.round((frameCount * 1000) / (now - lastTime));
        if (fpsElement) {
          fpsElement.textContent = fps;
        }
        frameCount = 0;
        lastTime = now;
      }
      
      if (debugMode) {
        requestAnimationFrame(updateFPS);
      }
    }
    
    // 解像度情報の取得
    function updateResolution() {
      const video = document.querySelector('video');
      if (video && resolutionElement) {
        video.addEventListener('loadedmetadata', () => {
          resolutionElement.textContent = `${video.videoWidth}x${video.videoHeight}`;
        });
      }
    }
    
    // 初期化
    document.addEventListener('DOMContentLoaded', function() {
      console.log('AR.jsアプリケーション初期化完了');
      
      // 5秒後にマーカーが検出されていない場合のヒント
      setTimeout(() => {
        if (!marker.object3D.visible) {
          console.log('マーカー検出のヒントを表示');
          status.textContent = '💡 マーカーを画面中央に配置し、ゆっくり動かしてください';
        }
      }, 5000);
      
      updateResolution();
      updateFPS();
    });
    
    // クリックイベント
    document.addEventListener('click', function(event) {
      if (event.target.classList.contains('clickable')) {
        console.log('3Dオブジェクトがクリックされました');
      }
    });
  </script>
</body>
</html>